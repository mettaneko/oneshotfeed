<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß TikTok Database Fixer</title>
    <style>
        /* —Ç–æ—Ç –∂–µ CSS –∫–∞–∫ –≤—ã—à–µ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2d3748; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #718096; margin-bottom: 40px; font-size: 1.2em; }
        .status { text-align: center; font-size: 1.8em; font-weight: bold; padding: 20px; border-radius: 15px; margin: 30px 0; transition: all 0.3s ease; }
        .status.success { background: #c6f6d5; color: #22543d; }
        .status.loading { background: #fed7aa; color: #744210; }
        .status.error { background: #fed7d7; color: #742a2a; }
        .fix-btn { display: block; width: 100%; padding: 25px; font-size: 1.5em; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        .fix-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .fix-btn:active { transform: translateY(-1px); }
        .fix-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        #log { background: #1a202c; color: #e2e8f0; padding: 25px; border-radius: 15px; margin-top: 30px; white-space: pre-wrap; font-family: 'Fira Code', monospace; font-size: 14px; line-height: 1.6; max-height: 500px; overflow-y: auto; border: 1px solid #2d3748; }
        .info { background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 10px; padding: 20px; margin: 20px 0; }
        .next-steps { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 10px; padding: 20px; margin-top: 20px; }
    </style>
</head>
<body>
    <!-- —Ç–æ—Ç –∂–µ HTML -->
    <div class="container">
        <h1>üéØ TikTok Database Fixer</h1>
        <p class="subtitle">949 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ —Å –≤–µ—á–Ω—ã–º–∏ TikWM —Å—Å—ã–ª–∫–∞–º–∏</p>
        <div class="status" id="status">‚úÖ –ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É</div>
        <button class="fix-btn" onclick="fixDatabase()" id="fixBtn">üöÄ –ü–û–§–ò–ö–°–ò–¢–¨ –ë–ê–ó–£</button>
        <div class="info">
            <strong>üìã –°—Ç–∞—Ç—É—Å:</strong><br>paste.txt: 953 ‚Üí 949 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö<br>Upstash KV REST API –≥–æ—Ç–æ–≤
        </div>
        <div id="log"></div>
        <div class="next-steps" id="nextSteps" style="display: none;">
            <h3>‚úÖ –ì–û–¢–û–í–û! –í Vercel:</h3>
            <code>const videosJson = await kv.get("feed_videos");<br>const videos = JSON.parse(videosJson || "[]");</code>
        </div>
    </div>

    <script>
        const REST_URL = "https://subtle-aphid-39325.upstash.io";
        const REST_TOKEN = "AZmdAAIncDE2ZDhiNDI0ZTEzOTI0MTg0OWVkODg0NzkzYTU1ZjQxMnAxMzkzMjU=";
        const KEY = "feed_videos";

        async function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus(text, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = `status ${type}`;
        }

        async function fixDatabase() {
            const btn = document.getElementById('fixBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ –§–∏–∫—Å–∏–Ω–≥...';
            updateStatus('‚è≥ –ó–∞–≥—Ä—É–∂–∞—é paste.txt...', 'loading');
            document.getElementById('log').textContent = '';

            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞
                const response = await fetch('./paste.txt');
                const content = await response.text();
                log(`‚úÖ paste.txt –∑–∞–≥—Ä—É–∂–µ–Ω (${content.length.toLocaleString()} —Å–∏–º–≤–æ–ª–æ–≤)`);

                // –ü–∞—Ä—Å–∏–Ω–≥
                const matches = content.match(/\{.*?"id".*?\}/gs) || [];
                log(`üì• –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${matches.length}`);

                const seen = new Set();
                const cleaned = [];
                
                for (let i = 0; i < matches.length; i++) {
                    try {
                        const video = JSON.parse(matches[i]);
                        const id = video.id;
                        if (!id || seen.has(id)) continue;
                        seen.add(id);
                        video.videoUrl = `https://www.tikwm.com/video/media/play/${id}.mp4`;
                        video.cover = `https://www.tikwm.com/video/cover/${id}.jpg`;
                        video.desc = "on tiktok";
                        video.author = String(video.author || "").replace("@", "");
                        cleaned.push(JSON.stringify(video));
                    } catch(e) {}
                }

                log(`‚ú® –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ: ${cleaned.length}`);
                updateStatus(`‚ú® ${cleaned.length} –≥–æ—Ç–æ–≤–æ!`, 'success');

                const headers = {
                    "Authorization": `Bearer ${REST_TOKEN}`,
                    "Content-Type": "application/json"
                };

                // üî• –ü–†–ê–í–ò–õ–¨–ù–´–ô UPSTASH KV API!
                log("üóë –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—É—é –±–∞–∑—É...");
                const deleteRes = await fetch(`${REST_URL}/${KEY}`, {
                    method: 'DELETE',
                    headers
                });
                log(`DELETE: ${deleteRes.status}`);

                // üî• RPUSH –ë–ê–¢–ß–ê–ú–ò (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!)
                log("üöÄ –ó–∞–ª–∏–≤–∞—é RPUSH –±–∞—Ç—á–∞–º–∏...");
                const BATCH_SIZE = 50;
                
                for (let i = 0; i < cleaned.length; i += BATCH_SIZE) {
                    const batch = cleaned.slice(i, i + BATCH_SIZE);
                    const rpushRes = await fetch(`${REST_URL}/rpush`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ [KEY]: batch })
                    });
                    
                    log(`üì§ –ë–∞—Ç—á ${Math.floor(i/BATCH_SIZE)+1}: ${rpushRes.status}`);
                    
                    if (!rpushRes.ok) {
                        const error = await rpushRes.text();
                        throw new Error(`RPUSH failed: ${rpushRes.status} - ${error}`);
                    }
                }

                updateStatus('üéâ –ë–ê–ó–ê –ü–û–§–ò–ö–®–ï–ù–ê!', 'success');
                log(`‚úÖ –£–°–ü–ï–•! ${cleaned.length} –≤–∏–¥–µ–æ –≤ LIST feed_videos`);
                log("üîç CLI: LLEN feed_videos");
                log("üîç CLI: LRANGE feed_videos 0 4");
                
                document.getElementById('nextSteps').style.display = 'block';
                btn.textContent = '‚úÖ –§–ò–ö–° –£–°–ü–ï–®–ï–ù!';
                btn.style.background = '#10b981';

            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`);
                updateStatus('‚ùå –û—à–∏–±–∫–∞!', 'error');
                btn.disabled = false;
                btn.textContent = 'üöÄ –ü–û–§–ò–ö–°–ò–¢–¨ –ë–ê–ó–£';
            }
        }
    </script>
</body>
</html>
