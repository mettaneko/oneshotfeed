<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß TikTok Database Fixer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.95); 
            border-radius: 20px; 
            padding: 40px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 { 
            text-align: center; 
            color: #2d3748; 
            margin-bottom: 10px; 
            font-size: 2.5em;
        }
        .subtitle { 
            text-align: center; 
            color: #718096; 
            margin-bottom: 40px; 
            font-size: 1.2em;
        }
        .status { 
            text-align: center; 
            font-size: 1.8em; 
            font-weight: bold; 
            padding: 20px; 
            border-radius: 15px; 
            margin: 30px 0; 
            transition: all 0.3s ease;
        }
        .status.success { background: #c6f6d5; color: #22543d; }
        .status.loading { background: #fed7aa; color: #744210; }
        .status.error { background: #fed7d7; color: #742a2a; }
        .fix-btn { 
            display: block; 
            width: 100%; 
            padding: 25px; 
            font-size: 1.5em; 
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4); 
            color: white; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .fix-btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        .fix-btn:active { transform: translateY(-1px); }
        .fix-btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none;
        }
        #log { 
            background: #1a202c; 
            color: #e2e8f0; 
            padding: 25px; 
            border-radius: 15px; 
            margin-top: 30px; 
            white-space: pre-wrap; 
            font-family: 'Fira Code', monospace; 
            font-size: 14px; 
            line-height: 1.6; 
            max-height: 500px; 
            overflow-y: auto;
            border: 1px solid #2d3748;
        }
        .info { 
            background: rgba(99, 102, 241, 0.1); 
            border: 1px solid rgba(99, 102, 241, 0.3); 
            border-radius: 10px; 
            padding: 20px; 
            margin: 20px 0; 
        }
        .next-steps { 
            background: rgba(34, 197, 94, 0.1); 
            border: 1px solid rgba(34, 197, 94, 0.3); 
            border-radius: 10px; 
            padding: 20px; 
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ TikTok Database Fixer</h1>
        <p class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∏–Ω–∏—Ç 953 ‚Üí 949 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ —Å –≤–µ—á–Ω—ã–º–∏ TikWM —Å—Å—ã–ª–∫–∞–º–∏</p>
        
        <div class="status" id="status">‚úÖ –ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É</div>
        
        <button class="fix-btn" onclick="fixDatabase()" id="fixBtn">
            üöÄ –ü–û–§–ò–ö–°–ò–¢–¨ –ë–ê–ó–£ (949 –≤–∏–¥–µ–æ)
        </button>
        
        <div class="info">
            <strong>üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:</strong><br>
            ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ—Ç paste.txt (892k —Å–∏–º–≤–æ–ª–æ–≤)<br>
            ‚Ä¢ –ù–∞—Ö–æ–¥–∏—Ç 953 JSON –∑–∞–ø–∏—Å–∏<br>
            ‚Ä¢ –£–¥–∞–ª—è–µ—Ç 4 –¥—É–±–ª–∏–∫–∞—Ç–∞ ‚Üí 949 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö<br>
            ‚Ä¢ –î–æ–±–∞–≤–ª—è–µ—Ç TikWM —Å—Å—ã–ª–∫–∏<br>
            ‚Ä¢ –ó–∞–ª–∏–≤–∞–µ—Ç –≤ Upstash (feed_videos)
        </div>
        
        <div id="log"></div>
        
        <div class="next-steps" id="nextSteps" style="display: none;">
            <h3>‚úÖ –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞:</h3>
            <ol>
                <li>–í Vercel: <code>const videos = JSON.parse(await kv.get("feed_videos") || "[]");</code></li>
                <li>CLI: <code>GET feed_videos</code> ‚Üí –º–∞—Å—Å–∏–≤ 949 –≤–∏–¥–µ–æ</li>
                <li>–°–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å TikWM —Å—Å—ã–ª–∫–∞–º–∏! üéâ</li>
            </ol>
        </div>
    </div>

    <script>
        const REST_URL = "https://subtle-aphid-39325.upstash.io";
        const REST_TOKEN = "AZmdAAIncDE2ZDhiNDI0ZTEzOTI0MTg0OWVkODg0NzkzYTU1ZjQxMnAxMzkzMjU=";
        const KEY = "feed_videos";

        async function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type}] ${msg}`);
        }

        function updateStatus(text, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = `status ${type}`;
        }

        async function fixDatabase() {
            const btn = document.getElementById('fixBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ –§–∏–∫—Å–∏–Ω–≥...';

            updateStatus('‚è≥ –ó–∞–≥—Ä—É–∂–∞—é paste.txt...', 'loading');
            document.getElementById('log').textContent = '';

            try {
                // üì• –ó–∞–≥—Ä—É–∑–∫–∞
                const response = await fetch('./paste.txt');
                if (!response.ok) throw new Error(`paste.txt –Ω–µ –Ω–∞–π–¥–µ–Ω (${response.status})`);
                
                const content = await response.text();
                log(`‚úÖ paste.txt –∑–∞–≥—Ä—É–∂–µ–Ω (${content.length.toLocaleString()} —Å–∏–º–≤–æ–ª–æ–≤)`);

                // üîç –ü–∞—Ä—Å–∏–Ω–≥ JSON
                const matches = content.match(/\{.*?"id".*?\}/gs) || [];
                log(`üì• –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${matches.length}`);

                const seen = new Set();
                const cleaned = [];
                
                for (let i = 0; i < matches.length; i++) {
                    const item = matches[i];
                    try {
                        const video = JSON.parse(item);
                        const id = video.id;
                        
                        if (!id || seen.has(id)) continue;
                        
                        seen.add(id);
                        video.videoUrl = `https://www.tikwm.com/video/media/play/${id}.mp4`;
                        video.cover = `https://www.tikwm.com/video/cover/${id}.jpg`;
                        video.desc = "on tiktok";
                        video.author = String(video.author || "").replace("@", "");
                        
                        cleaned.push(JSON.stringify(video));
                        
                        if (cleaned.length % 100 === 0) {
                            log(`üîÑ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${cleaned.length}/${matches.length}`);
                        }
                    } catch(e) {
                        // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –±–∏—Ç—ã–µ
                    }
                }

                log(`‚ú® –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ: ${cleaned.length}`);
                updateStatus(`‚ú® ${cleaned.length} –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!`, 'success');

                const headers = {
                    "Authorization": `Bearer ${REST_TOKEN}`,
                    "Content-Type": "application/json"
                };

                // üóë –û—á–∏—Å—Ç–∫–∞
                log("üóë –û—á–∏—â–∞—é —Å—Ç–∞—Ä—É—é –±–∞–∑—É...");
                await fetch(`${REST_URL}/${KEY}`, { method: 'DELETE', headers });
                log("‚úÖ –°—Ç–∞—Ä–∞—è –±–∞–∑–∞ —É–¥–∞–ª–µ–Ω–∞");

                // üöÄ –ó–∞–ª–∏–≤–∫–∞
                updateStatus('üöÄ –ó–∞–ª–∏–≤–∞—é –≤ Upstash...', 'loading');
                log("üöÄ –ó–∞–ª–∏–≤–∞—é JSON –º–∞—Å—Å–∏–≤...");
                
                const uploadRes = await fetch(`${REST_URL}/${KEY}`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(cleaned)
                });

                if (uploadRes.ok) {
                    updateStatus('üéâ –ë–ê–ó–ê –ü–û–§–ò–ö–®–ï–ù–ê!', 'success');
                    log(`‚úÖ –£–°–ü–ï–•! ${cleaned.length} –≤–∏–¥–µ–æ –∑–∞–ª–∏—Ç–æ –≤ ${KEY}`);
                    log("üîç CLI: GET feed_videos");
                    log("üîç Vercel: JSON.parse(await kv.get('feed_videos'))");
                    
                    document.getElementById('nextSteps').style.display = 'block';
                    btn.textContent = '‚úÖ –§–ò–ö–° –£–°–ü–ï–®–ï–ù!';
                    btn.style.background = '#10b981';
                } else {
                    const errorText = await uploadRes.text();
                    throw new Error(`Upload failed: ${uploadRes.status} - ${errorText}`);
                }

            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                updateStatus('‚ùå –û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å paste.txt', 'error');
                btn.textContent = 'üöÄ –ü–û–§–ò–ö–°–ò–¢–¨ –ë–ê–ó–£';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
