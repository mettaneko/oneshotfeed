<!DOCTYPE html>
<html>
<head>
    <title>üîß TikTok Fixer</title>
    <style>body{font-family:Arial;padding:40px;background:#f5f5f5;}#log{background:black;color:lime;padding:20px;font-family:monospace;height:400px;overflow:auto;}</style>
</head>
<body>
    <h1>üöÄ TikTok Database Fix</h1>
    <button onclick="fix()">–ü–û–§–ò–ö–°–ò–¢–¨ (949 –≤–∏–¥–µ–æ)</button>
    <div id="log"></div>

    <script>
        const REST_URL = "https://subtle-aphid-39325.upstash.io";
        const TOKEN = "AZmdAAIncDE2ZDhiNDI0ZTEzOTI0MTg0OWVkODg0NzkzYTU1ZjQxMnAxMzkzMjU=";
        const KEY = "feed_videos";

        async function log(msg) {
            document.getElementById('log').innerHTML += msg + '<br>';
            document.getElementById('log').scrollTop = 99999;
            console.log(msg);
        }

        async function testAuth() {
            const res = await fetch(`${REST_URL}`, {
                headers: { "Authorization": `Bearer ${TOKEN}` }
            });
            log(`TEST: ${res.status}`);
            const text = await res.text();
            log(`RESPONSE: ${text.substring(0,100)}`);
        }

        async function fix() {
            log("1. –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...");
            await testAuth();

            log("2. –ó–∞–≥—Ä—É–∂–∞—é paste.txt...");
            const res = await fetch('./paste.txt');
            const content = await res.text();
            log(`paste.txt: ${content.length} —Å–∏–º–≤–æ–ª–æ–≤`);

            const matches = content.match(/\{.*?"id".*?\}/gs) || [];
            log(`–ù–∞–π–¥–µ–Ω–æ JSON: ${matches.length}`);

            const seen = new Set();
            const cleaned = [];
            for (let item of matches) {
                try {
                    const video = JSON.parse(item);
                    if (video.id && !seen.has(video.id)) {
                        seen.add(video.id);
                        video.videoUrl = `https://www.tikwm.com/video/media/play/${video.id}.mp4`;
                        video.cover = `https://www.tikwm.com/video/cover/${video.id}.jpg`;
                        video.desc = "on tiktok";
                        video.author = String(video.author||"").replace("@","");
                        cleaned.push(JSON.stringify(video));
                    }
                } catch(e) {}
            }
            log(`–ì–æ—Ç–æ–≤–æ: ${cleaned.length} –≤–∏–¥–µ–æ`);

            // üî• UPSTASH KV: SET –∫–∞–∫ JSON array
            log("3. DEL —Å—Ç–∞—Ä–æ–π –±–∞–∑—ã...");
            await fetch(`${REST_URL}/${KEY}`, {
                method: 'DELETE',
                headers: { "Authorization": `Bearer ${TOKEN}` }
            });

            log("4. –ó–∞–ª–∏–≤–∞—é –¥–∞–Ω–Ω—ã–µ...");
            const setRes = await fetch(`${REST_URL}/${KEY}`, {
                method: 'POST',
                headers: { 
                    "Authorization": `Bearer ${TOKEN}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(cleaned)
            });
            
            log(`SET —Å—Ç–∞—Ç—É—Å: ${setRes.status}`);
            const setText = await setRes.text();
            log(`SET –æ—Ç–≤–µ—Ç: ${setText}`);

            log("üéâ –ì–û–¢–û–í–û!");
            log("Vercel: const videos = JSON.parse(await kv.get('feed_videos') || '[]');");
        }
    </script>
</body>
</html>
