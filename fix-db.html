<!DOCTYPE html>
<html>
<head>
    <title>üîß Fix TikTok DB</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; background: #f0f2f5; }
        button { padding: 20px 40px; font-size: 20px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        button:active { transform: translateY(0); }
        #log { background: #2d3748; color: #a0aec0; padding: 25px; border-radius: 10px; margin-top: 20px; white-space: pre-wrap; font-family: 'Courier New'; font-size: 14px; line-height: 1.6; max-height: 500px; overflow-y: auto; }
        .status { text-align: center; font-size: 24px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üéØ TikTok Database Fixer</h1>
    <p><strong>paste.txt</strong> –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º!</p>
    
    <div class="status" id="status">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É...</div>
    <button onclick="fixDatabase()">üöÄ –ü–û–§–ò–ö–°–ò–¢–¨ –ë–ê–ó–£ (949 –≤–∏–¥–µ–æ)</button>
    <div id="log"></div>

    <script>
        const REST_URL = "https://subtle-aphid-39325.upstash.io";
        const REST_TOKEN = "AZmdAAIncDE2ZDhiNDI0ZTEzOTI0MTg0OWVkODg0NzkzYTU1ZjQxMnAxMzkzMjU=";
        const KEY = "feed_videos";

        async function log(msg, color = '#a0aec0') {
            const logEl = document.getElementById('log');
            logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        async function fixDatabase() {
            const statusEl = document.getElementById('status');
            statusEl.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞—é paste.txt...';
            statusEl.style.color = '#ffa500';

            try {
                // üì• –ß–ò–¢–ê–ï–ú paste.txt —Å —Ç–æ–≥–æ –∂–µ —Å–∞–π—Ç–∞
                const response = await fetch('paste.txt');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const content = await response.text();
                log(`‚úÖ paste.txt –∑–∞–≥—Ä—É–∂–µ–Ω (${content.length} —Å–∏–º–≤–æ–ª–æ–≤)`);

                // üîç –ò–©–ï–ú JSON
                const matches = content.match(/\{.*?"id".*?\}/gs) || [];
                log(`üì• –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${matches.length}`);

                const seen = new Set();
                const cleaned = [];
                
                for (const item of matches) {
                    try {
                        const video = JSON.parse(item);
                        const id = video.id;
                        if (!id || seen.has(id)) continue;
                        
                        seen.add(id);
                        video.videoUrl = `https://www.tikwm.com/video/media/play/${id}.mp4`;
                        video.cover = `https://www.tikwm.com/video/cover/${id}.jpg`;
                        video.desc = "on tiktok";
                        video.author = String(video.author || "").replace("@", "");
                        
                        cleaned.push(JSON.stringify(video));
                    } catch(e) {}
                }

                log(`‚ú® –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ: ${cleaned.length}`);
                statusEl.textContent = `‚ú® ${cleaned.length} –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!`;
                statusEl.style.color = '#10b981';

                const headers = {
                    "Authorization": `Bearer ${REST_TOKEN}`,
                    "Content-Type": "application/json"
                };

                // üóë –û–ß–ò–©–ê–ï–ú
                log("üóë –û—á–∏—â–∞—é —Å—Ç–∞—Ä—É—é –±–∞–∑—É...");
                await fetch(`${REST_URL}/${KEY}`, { method: 'DELETE', headers });

                // üöÄ –ó–ê–õ–ò–í–ê–ï–ú (JSON –º–∞—Å—Å–∏–≤)
                log("üöÄ –ó–∞–ª–∏–≤–∞—é –≤ Upstash...");
                const uploadRes = await fetch(`${REST_URL}/${KEY}`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(cleaned)
                });

                if (uploadRes.ok) {
                    statusEl.textContent = 'üéâ –ë–ê–ó–ê –ü–û–§–ò–ö–®–ï–ù–ê!';
                    statusEl.style.color = '#10b981';
                    log(`‚úÖ –£–°–ü–ï–•! ${cleaned.length} –≤–∏–¥–µ–æ –≤ –±–∞–∑–µ`);
                    log("üîç –ü—Ä–æ–≤–µ—Ä—å –≤ CLI: GET feed_videos");
                } else {
                    const error = await uploadRes.text();
                    throw new Error(`Upload failed: ${uploadRes.status} - ${error}`);
                }

            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, '#ef4444');
                statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞!';
                statusEl.style.color = '#ef4444';
            }
        }
    </script>
</body>
</html>
