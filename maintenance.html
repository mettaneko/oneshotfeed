<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System Halted | World Machine</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body class="overlay-screen">

    <div class="maintenance-card" style="border: 1px solid var(--accent-color); padding: 40px; background: rgba(169, 149, 255, 0.03); max-width: 400px; text-align: center; position: relative;">

        <div class="glitch-text" style="font-size: 1.5rem; letter-spacing: 3px;">[ ВНИМАНИЕ ]</div>
        
        <h1 style="font-family: var(--font-mono); font-size: 1.1rem; margin: 15px 0; color: var(--text-color);">
            WORLD_MACHINE_STATUS: <span style="color: var(--error-red);">FRAGMENTED</span>
        </h1>
        
        <p style="font-size: 0.85rem; opacity: 0.7; line-height: 1.6; margin-bottom: 30px;">
            Мы пересобираем фрагменты реальности и обновляем базу данных. Пожалуйста, подождите. Мир скоро вернется в строй.
        </p>

        <div style="border-top: 1px solid rgba(255,255,255,0.1); pt-20; margin-top: 20px; padding-top: 20px;">
            <div style="font-family: var(--font-mono); font-size: 0.65rem; text-transform: uppercase; opacity: 0.4; margin-bottom: 10px;">
                Admin Bypass Protocol
            </div>
            
            <div style="position: relative; display: inline-block;">
                <input type="tel" id="2fa-input" class="code-input" maxlength="6" placeholder="______" 
                       style="background: #000; border: 1px solid #333; color: var(--accent-yellow); font-family: var(--font-mono); font-size: 1.5rem; text-align: center; width: 200px; padding: 10px; letter-spacing: 5px;">
                <div id="loading-spinner" style="display:none; position: absolute; right: -30px; top: 15px; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.1); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
            
            <div id="error-text" style="color: var(--error-red); font-family: var(--font-mono); font-size: 0.7rem; margin-top: 10px; display: none;">
                ACCESS_DENIED: INVALID_CODE
            </div>
        </div>
    </div>

    <button onclick="location.reload()" style="margin-top: 30px; background: none; border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.3); padding: 8px 20px; border-radius: 20px; font-family: var(--font-mono); font-size: 0.7rem; cursor: pointer; transition: 0.3s;">
        RETRY_CONNECTION
    </button>

    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .code-input:focus { border-color: var(--accent-color) !important; outline: none; box-shadow: 0 0 15px rgba(169, 149, 255, 0.2); }
    </style>

    <script>
        // Сохраняем твою логику сессии и проверки
        const SESSION_DURATION = 5 * 60 * 1000;

        function isTokenValid() {
            const token = localStorage.getItem('admin_bypass_token');
            if (!token) return false;
            try {
                const payload = JSON.parse(atob(token));
                return (Date.now() - payload.ts < SESSION_DURATION);
            } catch (e) { return false; }
        }

        if (isTokenValid()) window.location.href = '/';

        // Проверка восстановления системы
        setInterval(() => {
            fetch('/api/get_feed')
                .then(r => r.json())
                .then(d => { if (!d.maintenance) window.location.href = '/'; })
                .catch(() => {});
        }, 5000);

        const input = document.getElementById('2fa-input');
        const err = document.getElementById('error-text');
        const spinner = document.getElementById('loading-spinner');

        input.addEventListener('input', async () => {
            if (input.value.length === 6) {
                input.disabled = true;
                spinner.style.display = 'block';
                err.style.display = 'none';

                try {
                    const res = await fetch('/api/auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: input.value })
                    });

                    if (res.ok) {
                        const data = await res.json();
                        localStorage.setItem('admin_bypass_token', data.token);
                        input.style.borderColor = var(--accent-color);
                        setTimeout(() => window.location.href = '/', 500);
                    } else { throw new Error(); }
                } catch (e) {
                    spinner.style.display = 'none';
                    input.disabled = false;
                    err.style.display = 'block';
                    input.value = '';
                    input.focus();
                }
            }
        });
    </script>
</body>
</html>